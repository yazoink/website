<p>I&#39;m going to preface this by saying that I&#39;ve only been using NixOS for about a month so I don&#39;t know what I&#39;m doing and there&#39;s probably a much better way to do this.</p><br /><p>I was really surprised to find that Etterna isn&#39;t in nixpkgs, despite it being the largest linux software repository. Before switching to Nix I was using Arch, and Etterna is in the AUR so it was as easy as one command to install it.</p><br /><p>It seems that not many people have attempted to install Etterna on NixOS, probably for a good reason. This process was very long and annoying and I&#39;m mainly writing this to save anyone else who might try this a few hours and a headache.</p><br /><p>This is the module I&#39;m using to compile and install Etterna to the nix store (<code>etterna.nix</code>):</p><br /><div class='code-block'><code><p>{ stdenv, lib, fetchFromGitHub, cmake, nasm</p><p>, gtk2, glib, ffmpeg_4, alsa-lib, libmad, libogg, libvorbis</p><p>, glew, libpulseaudio, udev, openssl, doxygen, pkg-config</p><p>, libX11, libGLU, libGL, libXpm, libXext, libXxf86vm</p><p>}:</p><br /><p>stdenv.mkDerivation {</p><p>&emsp;pname = &quot;etterna&quot;;</p><p>&emsp;version = &quot;0.73-dev&quot;;</p><br /><p>&emsp;src = fetchFromGitHub {</p><p>&emsp;&emsp;owner = &quot;etternagame&quot;;</p><p>&emsp;&emsp;repo  = &quot;etterna&quot;;</p><p>&emsp;&emsp;rev   = &quot;develop&quot;;</p><p>&emsp;&emsp;sha256 = &quot;sha256-pAWC3z2aW2GKPzJ8fzLlv0fNWM7FeNSa8UVI933G2UY=&quot;;</p><p>&emsp;};</p><br /><p>&emsp;nativeBuildInputs = [ cmake nasm pkg-config ];</p><br /><p>&emsp;buildInputs = [</p><p>&emsp;&emsp;gtk2 glib ffmpeg_4 alsa-lib libmad libogg libvorbis</p><p>&emsp;&emsp;glew libpulseaudio udev openssl doxygen</p><p>&emsp;&emsp;libX11 libGLU libGL libXpm libXext libXxf86vm</p><p>&emsp;];</p><br /><p>&emsp;cmakeFlags = [</p><p>&emsp;&emsp;&quot;-DCMAKE_BUILD_TYPE=Release&quot;</p><p>&emsp;&emsp;&quot;-DWITH_SYSTEM_FFMPEG=1&quot;</p><p>&emsp;&emsp;&quot;-DGTK2_GDKCONFIG_INCLUDE_DIR=${gtk2.out}/lib/gtk-2.0/include&quot;</p><p>&emsp;&emsp;&quot;-DGTK2_GLIBCONFIG_INCLUDE_DIR=${glib.out}/lib/glib-2.0/include&quot;</p><p>&emsp;&emsp;&quot;-DWITH_CRASHPAD=OFF&quot;</p><p>&emsp;];</p><br /><p>&emsp;postInstall = &#39;&#39;&#39;&#39;;</p><br /></p><p>&emsp;meta = with lib; {</p><p>&emsp;&emsp;homepage = &quot;https://www.etterna.com/&quot;;</p><p>&emsp;&emsp;description = &quot;Free dance and rhythm game for Windows, Mac, and Linux&quot;;</p><p>&emsp;&emsp;platforms = platforms.linux;</p><p>&emsp;&emsp;license = licenses.mit;</p><p>&emsp;&emsp;maintainers = [ ];</p><p>&emsp;&emsp;broken = stdenv.isLinux &amp;&amp; stdenv.isAarch64;</p><p>&emsp;};</p><p>}</p></code></div><br /><p>Most of this was copied from <a href="https://github.com/not-leader/etterna-flake" target='_blank'>here</a> because everything I tried would fail to compile for one reason or another. I had to make a few modifications because after installing it as-is, I ran into an issue.</p><br /><p>To my knowledge, all of Etterna&#39;s data directories are hard-coded to be in the same directory as the executable binary. On other distros this wouldn&#39;t be as much of a problem, put it wherever you want and symlink the executable to <code>/usr/bin</code>.</p><br /><p>On NixOS, since directories in <code>/nix/store</code> are immutable and read-only, you can&#39;t have the data directories in there because they need to be written to, post-installation. This is a problem because if the Etterna binary isn&#39;t in the same directory as the data directories, it doesn&#39;t work.</p><br /><p>My solution to this was to create a systemd service that will run a script every rebuild. This script will copy all of Etterna&#39;s files in the nix store to <code>~/.local/share</code>, symlink all of the directories that need to be persistent to <code>~/.etterna</code> and create a <code>.desktop</code> file in <code>~/.local/share/applications</code>.</p><br /><p>I have all of these files in an <code>etterna</code> directory in my modules. This is what the <code>default.nix</code> file looks like:</p><br /><div class='code-block'><code><p>{pkgs, userConfigs, ...}:</p><p>let</p><p>&emsp;etterna = pkgs.callPackage ./etterna.nix {};</p><p>&emsp;script = ./local-install.sh;</p><p>&emsp;desktopFile = ./etterna.desktop;</p><p>in</p><p>{</p><p>&emsp;environment.systemPackages = [</p><p>&emsp;&emsp;etterna</p><p>&emsp;];</p><br /><p>&emsp;systemd.services.etterna-local-install = {</p><p>&emsp;&emsp;description = &quot;Install Etterna locally&quot;;</p><p>&emsp;&emsp;wantedBy = [&quot;multi-user.target&quot;];</p><p>&emsp;&emsp;serviceConfig = {</p><p>&emsp;&emsp;&emsp;Type = &quot;oneshot&quot;;</p><p>&emsp;&emsp;&emsp;ExecStart = &quot;${pkgs.bash}/bin/bash ${script} ${etterna} ${desktopFile} ${userConfigs.username}&quot;;</p><p>&emsp;&emsp;};</p><p>&emsp;};</p><p>}</p></code></div><br /><p>this is <code>local-install.sh</code>:</p><br /><div class='code-block'><code><p>homeDir=&quot;/home/$3&quot;</p><p>installDir=&quot;$homeDir/.local/share/Etterna&quot;</p><p>applicationsDir=&quot;$homeDir/.local/share/applications&quot;</p><br /><p>if [[ -d &quot;$installDir&quot; ]]; then</p><p>&emsp;rm -rf &quot;$installDir&quot;</p><p>&emsp;cp -r &quot;$1/Etterna&quot; &quot;$installDir&quot;</p><p>&emsp;rm -rf "$installDir/Announcers"</p><p>&emsp;rm -rf "$installDir/Assets"</p><p>&emsp;rm -rf "$installDir/NoteSkins"</p><p>&emsp;rm -rf "$installDir/Songs"</p><p>&emsp;rm -rf "$installDir/Themes"</p><p>else</p><p>&emsp;cp -r &quot;$1/Etterna&quot; &quot;$installDir&quot;</p><p>&emsp;mkdir -p &quot;$homeDir/.etterna/Save&quot;</p><p>&emsp;mv &quot;$installDir/Announcers&quot; &quot;$homeDir/.etterna&quot;</p><p>&emsp;mv &quot;$installDir/Assets&quot; &quot;$homeDir/.etterna&quot;</p><p>&emsp;mv &quot;$installDir/NoteSkins&quot; &quot;$homeDir/.etterna&quot;</p><p>&emsp;mv &quot;$installDir/Songs&quot; &quot;$homeDir/.etterna&quot;</p><p>&emsp;mv &quot;$installDir/Themes&quot; &quot;$homeDir/.etterna&quot;</p><p>fi</p><br /><p>ln -s &quot;$homeDir/.etterna/Announcers&quot; &quot;$installDir&quot;</p><p>ln -s &quot;$homeDir/.etterna/Assets&quot; &quot;$installDir&quot;</p><p>ln -s &quot;$homeDir/.etterna/NoteSkins&quot; &quot;$installDir&quot;</p><p>ln -s &quot;$homeDir/.etterna/Save&quot; &quot;$installDir&quot;</p><p>ln -s &quot;$homeDir/.etterna/Songs&quot; &quot;$installDir&quot;</p><p>ln -s &quot;$homeDir/.etterna/Themes&quot; &quot;$installDir&quot;</p><br /><p>if [[ -f &quot;$applicationsDir/etterna.desktop&quot; ]]; then</p><p>&emsp;rm &quot;$applicationsDir/etterna.desktop&quot;</p><p>fi</p><br /><p>cp &quot;$2&quot; &quot;$applicationsDir/etterna.desktop&quot;</p><p>echo &quot;Exec=$installDir/Etterna&quot; | tee -a &quot;$applicationsDir/etterna.desktop&quot;</p><br /><p>chown -R &quot;$3&quot;:users &quot;$homeDir/.etterna&quot;</p><p>chmod -R 755 &quot;$homeDir/.etterna&quot;</p><br /><p>mkdir &quot;$installDir/Cache&quot;</p><p>chown -R &quot;$3&quot;:users &quot;$installDir/Cache&quot;</p><p>chmod -R 755 &quot;$installDir/Cache&quot;</p></code></div><br /><p>and this is <code>etterna.desktop</code>:</p><br /><div class='code-block'><code><p>[Desktop Entry]</p><p>Name=Etterna</p><p>Comment=The Next Step in Dance Simulation</p><p>Type=Application</p><p>Categories=Game</p></code></div><br /></code><p>This configuration is working as of when I&#39;m writing this. If anyone has a better solution to this, feel free to <a href="mailto:yoinky@cock.li">email</a> me about it.</p>
